function forEach(collection,callback){var index,child;if(collection instanceof Array){collection.forEach(callback)}else if("length"in collection){for(index=0;index<collection.length;index++){if(callback(collection[index],index,collection)===false){break}}}else if(collection instanceof Element){index=0;for(child=collection.firstChild;child;child=child.nextSibling){if(child.nodeType==Node.ELEMENT_NODE){if(callback(child,index,collection)===false){break}index++}}}else{for(index in collection){if(callback(collection[index],index,collection)===false){break}}}}Array.prototype.intersect=function(other){return this.filter(function(element){return other.indexOf(element)>-1})};Array.prototype.diff=function(other){return this.filter(function(element){return other.indexOf(element)==-1})};function extend(base,members){var k,f;f=function(){this.init.apply(this,Array.prototype.slice.call(arguments))};if(base!=Object){f.prototype=Object.create(base.prototype)}for(k in members){f.prototype[k]=members[k]}if(!("init"in f.prototype)){f.prototype.init=function(){}}return f}function collapse(element,toHeight){toHeight=toHeight||0;if(!element._transitions){element._transitions=new Transitions(element);element._heightDelay=element._transitions.getTime("height")}delay=element._transitions.getTime("height");element._transitions.set("height");element.style.height=element.offsetHeight+"px";setTimeout(function(){element._transitions.set("height",element._heightDelay);element.style.height=toHeight+"px"},10)}function expand(element){if(!element._transitions){element._transitions=new Transitions(element);element._heightDelay=element._transitions.getTime("height")}element.style.height=element.scrollHeight+"px";setTimeout(function(){element._transitions.set("height");element.style.height="auto";element._transitions.set("height",element._heightDelay)},Math.round(element._heightDelay*1e3))}var UtilEventDispatcher=extend(Object,{on:function(event,listener){if(!("listeners"in this)){this.listeners={}}if(!(event in this.listeners)){this.listeners[event]=[]}this.listeners[event].push(listener)},off:function(event,listener){if("listeners"in this&&event in this.listeners){for(i=0;i<this.listeners[event].length;i++){if(this.listeners[event][i]==listener){this.listeners[event].splice(i,1);break}}}this.listeners[event].push(listener)},dispatch:function(event){var args,i,result,r;if("listeners"in this&&event in this.listeners&&this.listeners[event].length>0){args=Array.prototype.slice.call(arguments,1);for(i=0;i<this.listeners[event].length;i++){r=this.listeners[event][i].apply(this,args);if(typeof r!="undefined"){result=r}}}return result}});var FilterKit={EXACT_MATCH:2,resolveElement:function(el,multi){if(typeof el=="string"){return multi?document.querySelectorAll(el):document.querySelector(el)}else if(!(el instanceof Element)){return!multi&&el.length?el[0]:el}return multi?[el]:el},resolveOptions:function(options,defaults){var key;options=options||{};defaults=defaults||{};for(key in defaults){if(!(key in options)){options[key]=defaults[key]}else if(typeof options[key]=="object"&&typeof defaults[key]=="object"){options[key]=this.resolveOptions(options[key],defaults[key])}}return options},createElement:function(spec,attrs,style){var m,m2,i,tagName="div",el,key;if(m=spec.match(/^([a-zA-Z][a-zA-Z\-_:]*)/)){tagName=m[1]}el=document.createElement(tagName);m=spec.match(/#([a-zA-Z][a-zA-Z0-9\-_:]*)/);if(m){el.id=m[1]}m=spec.match(/(\.[a-zA-Z][a-zA-Z0-9\-_:.]*)+/);if(m){el.className=m[0].substr(1).replace(/\./g," ")}m=spec.match(/\[[^=]+="[^"]*"\]/g);if(m){for(i=0;i<m.length;i++){m2=m[i].match(/\[([^=]+)="([^"]*)"\]/);el.setAttribute(m2[1],m2[2])}}if(attrs){for(i in attrs){key=i.replace(/[A-Z]/g,"-$&").toLowerCase();el.setAttribute(key,attrs[i])}}if(style){for(i in style){el.style[i]=style[i]}}return el},getUid:function(prefix){var result;if(!this._uid){this._uid=0}result=(prefix||"")+this._uid;this._uid++;return result},Conditions:{},SelectOutput:{},Controls:{},Collections:{},CollectionViews:{},Util:{}};window.addEventListener("click",function(e){if(_(e.target).closest(".chip").length==0){_(".preselect.chip").removeClass("preselect")}});FilterKit.Conditions.Base=extend(Object,{init:function(initValue){this.addValue(initValue||"")},addValue:function(value){if(this.value instanceof Array){if(value instanceof Array){this.value=this.value.concat(value)}else{this.value.push(value)}}else{if(value instanceof Array){this.value=[this.value].concat(value)}else{this.value=[this.value,value]}}},removeValue:function(value){var index;if(this.value instanceof Array){if(value instanceof Array){this.value=this.value.diff(this.value,value)}else{index=this.value.indexOf(value);if(index>-1){this.value.splice(index,1)}}}else if(this.value==value){this.value=null}},hasValues:function(value){return this.value!==null&&(!(this.value instanceof Array)||this.value.length>0)},checkValue:function(value){return true},serializeQuery:function(name){return""}});FilterKit.Conditions.Eq=extend(FilterKit.Conditions.Base,{checkValue:function(value){var result=false;if(this.value instanceof Array){if(value instanceof Array){result=this.value.intersect(value).length>0}else{result=this.value.indexOf(value)>-1}}else{if(value instanceof Array){result=value.indexOf(this.value)>-1}else{result=this.value==value}}return result},serializeQuery:function(name){var queryParts=[];if(this.value instanceof Array){if(this.value.length==1){queryParts.push(name+"="+encodeURIComponent(this.value[0]))}else{this.value.forEach(function(value){queryParts.push(name+"[]="+encodeURIComponent(value))})}}else{queryParts.push(name+"="+encodeURIComponent(this.value))}return queryParts.join("&")}});FilterKit.Conditions.Like=extend(FilterKit.Conditions.Base,{addValue:function(value){this.value=value.toLowerCase()},checkValue:function(value){value=(""+value).toLowerCase();if(value==this.value){return FilterKit.EXACT_MATCH}return value.indexOf(this.value)>-1},serializeQuery:function(name){var queryParts=[];if(this.value instanceof Array){if(this.value.length==1){queryParts.push(name+"="+encodeURIComponent(this.value[0]))}else{this.value.forEach(function(value){queryParts.push(name+"[]="+encodeURIComponent(value))})}}else{queryParts.push(name+"="+encodeURIComponent(this.value))}return queryParts.join("&")}});FilterKit.Conditions.Lt=extend(FilterKit.Conditions.Base,{checkValue:function(value){return value<this.value},serializeQuery:function(name){return name+"[lt]="+encodeURIComponent(this.value)}});FilterKit.Conditions.Lte=extend(FilterKit.Conditions.Base,{checkValue:function(value){return value<=this.value},serializeQuery:function(name){return name+"[lte]="+encodeURIComponent(this.value)}});FilterKit.Conditions.Gt=extend(FilterKit.Conditions.Base,{checkValue:function(value){return value>this.value},serializeQuery:function(name){return name+"[gt]="+encodeURIComponent(this.value)}});FilterKit.Conditions.Gte=extend(FilterKit.Conditions.Base,{checkValue:function(value){return value>=this.value},serializeQuery:function(name){return name+"[gte]="+encodeURIComponent(this.value)}});FilterKit.Conditions.Geo=extend(FilterKit.Conditions.Base,{init:function(initValue){this.addValue(initValue)},addValue:function(value){var values;if(value instanceof Array){value=value[0]}values=value.split(",");this.lat=parseFloat(values[0]);this.lng=parseFloat(values[1]);this.distance=parseFloat(values[2]);this.searchString=values.length>3?values.slice(3).join(","):null},removeValue:function(value){this.lat=null},hasValues:function(){return this.lat!==null},checkValue:function(value){var distance;function radians(degrees){return degrees*Math.PI/180}function degrees(radians){return degrees*180/Math.PI}distance=degrees(Math.acos(Math.cos(radians(90-value.lat))*Math.cos(radians(90-this.lat))+Math.sin(radians(90-value.lat))*Math.sin(radians(90-thia.lat))*Math.cos(radians(value.lng-this.lng))))/360*40074;return distance<=this.distance},serializeQuery:function(name){return name+"[geo]="+encodeURIComponent(this.lat)+","+encodeURIComponent(this.lng)+","+encodeURIComponent(this.distance)+(this.searchString?","+encodeURIComponent(this.searchString):"")}});FilterKit.Value=extend(Object,{init:function(){this.conditions={}},addCondition:function(operand,value){if(operand in this.conditions){this.conditions[operand].addValue(value)}else{cls=operand?operand[0].toUpperCase()+operand.substr(1):"Eq";this.conditions[operand]=new FilterKit.Conditions[cls](value)}},removeCondition:function(operand,value){if(operand in this.conditions){this.conditions[operand].removeValue(value);if(!this.conditions[operand].hasValues()){delete this.conditions[operand]}}},checkValue:function(value){var operand,match=true;for(operand in this.conditions){match=this.conditions[operand].checkValue(value);if(!match||match===FilterKit.EXACT_MATCH){break}}return match},serializeQuery:function(name){var key,queryParts=[];for(key in this.conditions){queryParts.push(this.conditions[key].serializeQuery(name))}return queryParts.join("&")}});FilterKit.Filters=extend(UtilEventDispatcher,{init:function(){this.filters={};this.filterTags={};this.keyLabels={};this.valueLabels={};this.isBatching=false},getHash:function(key,value){return key+"_"+value},checkItem:function(item){var key,match=true,property;for(key in this.filters){if(key in item){match=this.filters[key].checkValue(item[key]);if(match===FilterKit.EXACT_MATCH){this.dispatch("exactMatch",item)}if(!match){break}}}return match},addValue:function(name,value,operand,replace){var tag,key;operand=operand||"eq";if(!(name in this.filters)||replace){this.clearValue(name);this.filters[name]=new FilterKit.Value;this.filterTags[name]={}}this.filters[name].addCondition(operand,value);tag={key:name,value:value,keyLabel:name,valueLabel:value,operand:operand,hash:this.getHash(name,value)};if(name in this.keyLabels){tag.keyLabel=this.keyLabels[name]}if(tag.hash in this.valueLabels){tag.valueLabel=this.valueLabels[tag.hash]}if(operand=="geo"&&this.filters[name].conditions.geo.searchString){tag.valueLabel=this.filters[name].conditions.geo.searchString}this.filterTags[name][tag.hash]=tag;this.dispatch("addtag",tag);if(!this.isBatching){this.dispatch("change")}else{this.batchChanges++}},removeValue:function(name,value,operand){var hash;operand=operand||"eq";if(name in this.filters){this.filters[name].removeCondition(operand,value);hash=this.getHash(name,value);if(hash in this.filterTags[name]){this.dispatch("removetag",this.filterTags[name][hash])}}if(!this.isBatching){this.dispatch("change")}else{this.batchChanges++}},clearValue:function(name){var hash;if(name in this.filterTags){for(hash in this.filterTags[name]){this.dispatch("removetag",this.filterTags[name][hash])}delete this.filterTags[name]}if(name in this.filters){delete this.filters[name]}},clearAll:function(){var name;for(name in this.filters){this.clearValue(name)}if(!this.isBatching){this.dispatch("change")}else{this.batchChanges++}},serializeQuery:function(){var key,queryParts=[];for(key in this.filters){queryParts.push(this.filters[key].serializeQuery(key))}return queryParts.join("&")},startBatch:function(){this.batchChanges=0;this.isBatching=true},endBatch:function(){if(this.isBatching&&this.batchChanges>0){this.dispatch("change")}this.isBatching=false},unserializeQuery:function(query){var i,key,operand,value,queryParts,m;this.startBatch();this.clearAll();queryParts=query.replace(/^\?/,"").split("&");for(i=0;i<queryParts.length;i++){if(m=queryParts[i].match(/^([^\[=]+)(\[[^\]]*\])?=([^$]*)/)){key=m[1];operand=m[2]?m[2].replace(/^\[|\]$/g,""):"eq";value=decodeURIComponent(m[3]);this.addValue(key,value,operand,operand=="geo")}}this.endBatch()},setKeyLabel:function(key,label){this.keyLabels[key]=label},setValueLabel:function(key,value,label){this.valueLabels[this.getHash(key,value)]=label},setLabels:function(labels){var key,i;for(key in labels){if(key!="introtext"&&key!="fulltext"){if("label"in labels[key]){this.setKeyLabel(key,labels[key].label)}if("options"in labels[key]){for(i in labels[key].options){if("label"in labels[key].options[i]){this.setValueLabel(key,labels[key].options[i].value,labels[key].options[i].label)}}}}}}});FilterKit.Collections.Base=extend(UtilEventDispatcher,{setFilters:function(filters){this.filters=filters;filters.on("change",this.update.bind(this))},update:function(){var i;for(i=0;i<this.items.length;i++){this.items[i].isFiltered=this.filters.checkItem(this.items[i])}this.dispatch("update",this.items)},getPreviousFilteredItem:function(fromIndex,wrap,returnIndex,skipSelected){var index;index=fromIndex=fromIndex==-1?0:fromIndex;do{index--;if(index<=0){if(wrap){index=index+this.items.length-1}else{index=0;break}}}while(index!=fromIndex&&(!this.items[index].isFiltered||skipSelected&&this.items[index].isSelected));return returnIndex?index:this.items[index]},getNextFilteredItem:function(fromIndex,wrap,returnIndex,skipSelected){var index;index=fromIndex=typeof fromIndex=="undefined"?-1:fromIndex;do{index++;if(index>this.items.length){if(wrap){index=0}else{index=this.items.length-1;break}}}while(index!=fromIndex&&index<this.items.length&&(!this.items[index].isFiltered||skipSelected&&this.items[index].isSelected));return returnIndex?index:this.items[index]},selectItem:function(value,replace){var i,found;if(!("selectedValues"in this)){this.selectedValues=[];this.preSelectedValues=[]}if(typeof value=="object"){if(this.items.indexOf(value)>-1){if(replace){for(i=0;i<this.items.length;i++){this.items[i].isSelected=false}}value.isSelected=true;this.selectedValues.push(value.value);this.dispatch("selectItem",value,replace)}else{this.preSelectedValues.push(value.value)}}else{for(i=0;i<this.items.length;i++){if(this.items[i].value==value){this.items[i].isSelected=true;this.selectedValues.push(this.items[i].value);found=true;this.dispatch("selectItem",this.items[i],replace)}else if(replace){this.items[i].isSelected=false}}if(!found){this.preSelectedValues.push(/^\d+$/.test(value)?parseInt(value):value)}}},unselectItem:function(value){var i,index;if(!("selectedValues"in this)){this.selectedValues=[]}if(typeof value=="object"){if(this.items.indexOf(value)>-1){if(this.dispatch("beforeUnselectItem",value)!==false){value.isSelected=false;if((index=this.selectedValues.indexOf(value.value))>-1){this.selectedValues.splice(index,1)}this.dispatch("unselectItem",value)}}}else{for(i=0;i<this.items.length;i++){if(this.items[i].value==value){if(this.dispatch("beforeUnselectItem",this.items[i])!==false){this.items[i].isSelected=false;if((index=this.selectedValues.indexOf(this.items[i].value))>-1){this.selectedValues.splice(index,1)}this.dispatch("unselectItem",this.items[i])}}}}},addItem:function(item){if(this.items&&this.items instanceof Array){item.isFiltered=true;item.isSelected=false;this.items.unshift(item);this.dispatch("update",this.items)}}});FilterKit.Collections.DOM=extend(FilterKit.Collections.Base,{init:function(el,filters,options){this.items=[];this.container=FilterKit.resolveElement(el);this.options=FilterKit.resolveOptions(options,{itemSelector:".item"});this.collectItems();this.setFilters(filters)},collectItems:function(){var elements,callback,that,uid;function elementToItem(el){var item={value:el.getAttribute("data-value")||uid+"",label:el.textContent.replace(/^\s+|\s+$/g,"")};if(item.value==uid){uid++;el.setAttribute("data-value",item.value)}return item}uid=0;elements=this.container.querySelectorAll(this.options.itemSelector);that=this;callback="elementToItem"in this.options&&this.options.elementToItem?this.options.elementToItem:elementToItem;this.items=[];forEach(elements,function(el){var item=callback(el);item.element=el;item.isFiltered=true;that.items.push(item)})}});FilterKit.Collections.Array=extend(FilterKit.Collections.Base,{init:function(items,filters){this.items=items;forEach(this.items,function(item){item.isFiltered=true});this.setFilters(filters)}});FilterKit.Collections.AjaxJSON=extend(FilterKit.Collections.Base,{init:function(filters,options){this.items=[];this.options=FilterKit.resolveOptions(options,{baseUrl:location.pathname});this.setFilters(filters);this.fetchItems(this.options.baseUrl)},parseResponse:function(responseText){var selectedValues,preSelectedValues,that;that=this;selectedValues=this.selectedValues||[];preSelectedValues=this.preSelectedValues||[];result=JSON.parse(responseText);this.items=result instanceof Array?result:result.items;forEach(this.items,function(item){var index;item.isFiltered=true;item.isSelected=selectedValues.indexOf(item.value)>-1;if((index=preSelectedValues.indexOf(item.value))>-1){preSelectedValues.splice(index,1);that.selectItem(item)}});this.dispatch("update",this.items);forEach(this.items,function(item){if(item.isExactMatch){that.filters.dispatch("exactMatch",item)}})},fetchItems:function(url){var xhr,that;if(!this.isFetching){this.isFetching=true;that=this;xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){var result,url;if(this.readyState==4){if(this.status==200){that.parseResponse(this.responseText)}else{console.error("Fetch JSON items - "+url+" responded with "+this.statusText)}that.isFetching=false;if(that.queueUrl){url=that.queueUrl;that.queueUrl=null;that.fetchItems(url)}}};xhr.open("get",url,true);xhr.send()}else{this.queueUrl=url}},update:function(){var query,url;query=this.filters.serializeQuery();url=this.options.baseUrl+(query?"?"+query:"");this.fetchItems(url)}});FilterKit.Collections.AjaxHTML=extend(FilterKit.Collections.AjaxJSON,{parseResponse:function(responseText){this.dispatch("update",responseText)}});FilterKit.CollectionViews.Div=extend(UtilEventDispatcher,{init:function(el,collection,options){var templateEl,view;view=this;this.container=FilterKit.resolveElement(el);this.collection=collection;this.options=FilterKit.resolveOptions(options,{showSelected:"highlighted",maxVisible:0,multiple:false});templateEl=this.container.querySelector(".itemtemplate");if(templateEl){this.template=templatify(templateEl.innerHTML.replace(/&lt;/g,"<").replace(/&gt;/g,">"));templateEl.parentElement.removeChild(templateEl)}else{this.template=templatify('<div class="item"><%= label %></div>')}this.noResultsEl=this.container.querySelector(".noresults");if(this.noResultsEl){_(this.noResultsEl).remove()}this.addItemEl=this.container.querySelector(".additem");if(this.addItemEl){this.addItemTemplate=this.addItemEl.innerHTML;_(this.addItemEl).remove()}collection.on("update",this.onUpdate.bind(this));collection.on("selectItem",this.onSelect.bind(this));collection.on("unselectItem",this.onUnselect.bind(this));_(this.container).delegate("click",".item",function(e){e.preventDefault();if(this==view.addItemEl){view.dispatch("addItem",view.term)}else if(this.hasAttribute("data-value")){collection.selectItem(this.getAttribute("data-value"),!options.multiple)}})},onUpdate:function(result){var i,html,numVisible,div;numVisible=0;if(typeof result=="string"){this.container.innerHTML=result}else if(this.template){this.container.innerHTML="";div=document.createElement("div");for(i=0;i<result.length;i++){div.innerHTML=this.template(result[i]);result[i].element=div.firstElementChild;this.container.appendChild(result[i].element);result[i].element.setAttribute("data-value",result[i].value);if(result[i].isFiltered&&(!result[i].isSelected||this.options.showSelected!="hidden")){result[i].element.style.display="block";if(++numVisible>=this.options.maxVisible&&this.options.maxVisible>0){break}}else{result[i].element.style.display="none"}}}else{for(i=0;i<result.length;i++){if("element"in result[i]){if(result[i].isFiltered&&(!result[i].isSelected||this.options.showSelected!="hidden")){result[i].element.style.display="block";if(++numVisible>=this.options.maxVisible&&this.options.maxVisible>0){break}}else{result[i].element.style.display="none"}}}}if((numVisible==0||this.innerHTML=="")&&this.noResultsEl){this.container.appendChild(this.noResultsEl)}if(this.addItemEl&&this.term){this.container.appendChild(this.addItemEl)}},onSelect:function(item,replace){switch(this.options.showSelected){case"highlighted":this.highlightItem(item,"active",replace);break;case"hidden":if("element"in item){item.element.style.display="none"}break}},onUnselect:function(item){switch(this.options.showSelected){case"highlighted":item.element.classList.remove("active");break;case"hidden":if("element"in item){item.element.style.display="block"}break}},highlightItem:function(item,className,replace,scrollTo){var currHighlighted,items,index;className=className||"highlight";if(replace){currHighlighted=this.container.querySelector("."+className);if(currHighlighted){currHighlighted.classList.remove(className)}}currHighlighted=null;items=this.container.querySelectorAll(".item");if("element"in item){item.element.classList.add(className);currHighlighted=item.element;forEach(items,function(it,idx){if(it==currHighlighted){index=idx}})}else{index=0;forEach(items,function(it,idx){if(it.getAttribute("data-value")==item.value){it.classList.add(className);currHighlighted=it;index=idx}})}if(currHighlighted&&scrollTo){if(currHighlighted.offsetTop<this.container.scrollTop){this.container.scrollTop=currHighlighted.offsetTop}else if(currHighlighted.offsetTop+currHighlighted.offsetHeight>this.container.scrollTop+this.container.clientHeight){this.container.scrollTop=currHighlighted.offsetTop+currHighlighted.offsetHeight-this.container.clientHeight}}return index},setTerm:function(term){this.term=term;if(this.addItemEl){this.addItemEl.innerHTML=this.addItemTemplate.replace(/\{term\}/g,term)}}});const NAVKEY_BACKSPACE=8;const NAVKEY_BACKSPACE_EMPTY=88;const NAVKEY_UPARROW=38;const NAVKEY_DOWNARROW=40;const NAVKEY_RETURN=13;FilterKit.Controls.Textfield=extend(Object,{init:function(el,filters,options){var that=this;input=FilterKit.resolveElement(el);options=FilterKit.resolveOptions(options,{realTime:false,keyboardNavigation:false,operand:"like",filledClass:null});if(input){if(!input.name){input.name=FilterKit.getUid("textfield")}input.addEventListener("keydown",function(e){if(e.which==13){e.preventDefault()}else if(options.keyboardNavigation&&(e.which==NAVKEY_UPARROW||e.which==NAVKEY_DOWNARROW)){e.preventDefault();that.onNavigationKey(e.which)}this.lastValue=this.value});input.addEventListener("keyup",function(e){if(e.which==13){e.preventDefault();if(this.value!=this.lastValue){filters.addValue(this.name,this.value,options.operand,true);that.onChange(this.value)}}else if(options.realTime){if(this.value!=this.lastValue){filters.addValue(this.name,this.value,options.operand,true);that.onChange(this.value)}}if(options.filledClass){if(this.value)this.classList.add(options.filledClass);else this.classList.remove(options.filledClass)}if(options.keyboardNavigation&&(e.which==NAVKEY_BACKSPACE||e.which==NAVKEY_RETURN)){if(e.which==NAVKEY_BACKSPACE&&!this.lastValue){that.onNavigationKey(NAVKEY_BACKSPACE_EMPTY)}else{that.onNavigationKey(e.which)}}})}},onNavigationKey:function(key){},onChange:function(value){}});FilterKit.Controls.Checkboxes=extend(Object,{init:function(el,filters){var container,checkboxes;function onCbChange(e){if(this.checked){filters.addValue(this.name.replace(/\[\]$/,""),this.value)}else{filters.removeValue(this.name.replace(/\[\]$/,""),this.value)}}container=FilterKit.resolveElement(el);checkboxes=container.querySelectorAll('input[type="checkbox"]');forEach(checkboxes,function(checkbox){checkbox.addEventListener("change",onCbChange)})}});FilterKit.Controls.RadioButtons=extend(Object,{init:function(el,filters){var container,radioButtons;function onRadioChange(e){if(this.checked){filters.addValue(this.name,this.value,"eq",true)}}container=FilterKit.resolveElement(el);radioButtons=container.querySelectorAll('input[type="radio"]');forEach(radioButtons,function(radio){radio.addEventListener("change",onRadioChange)})}});FilterKit.Controls.Container=extend(Object,{init:function(el,filters,options){var container,radioButtons,checkboxes,inputs;options=FilterKit.resolveOptions(options,{realTime:false,textFieldOperand:"like"});function onCbChange(e){if(this.checked){filters.addValue(this.name.replace(/\[\]$/,""),this.value)}else{filters.removeValue(this.name.replace(/\[\]$/,""),this.value)}}function onRadioChange(e){if(this.checked){filters.addValue(this.name,this.value,"eq",true)}}function onKeyDown(e){if(e.which==13){e.preventDefault()}}function onKeyUp(e){if(e.which==13){e.preventDefault();filters.addValue(this.name,this.value,options.textFieldOperand,true)}else if(options.realTime){filters.addValue(this.name,this.value,options.textFieldOperand,true)}}container=FilterKit.resolveElement(el);checkboxButtons=container.querySelectorAll('input[type="checkbox"]');forEach(checkboxButtons,function(checkbox){checkbox.addEventListener("change",onCbChange)});radioButtons=container.querySelectorAll('input[type="radio"]');forEach(radioButtons,function(radio){radio.addEventListener("change",onRadioChange)});inputs=container.querySelectorAll('input[type="text"]');forEach(inputs,function(input){input.addEventListener("keyup",onKeyUp);input.addEventListener("keydown",onKeyDown)})}});FilterKit.SelectOutput.Chips=extend(UtilEventDispatcher,{itemClass:"chip",init:function(el,options){var output=this;this.options=FilterKit.resolveOptions({name:null,addHiddenInput:false});this.container=FilterKit.resolveElement(el);_(this.container).delegate("click",".close.icon",function(){output.removeChip(this.parentElement)});_(this.container).delegate("click","."+this.itemClass,function(e){if(e.target==this){output.preselectChip(this)}});window.addEventListener("keyup",function(e){if(e.target.nodeName!="INPUT"&&e.target.nodeName!="TEXTAREA"&&e.which==8){output.removePreselected()}})},getLastChip:function(){var lastChip,child;for(child=this.container.lastElementChild;child;child=child.previousElementSibling){if(child.classList.contains(this.itemClass)){lastChip=child;break}}return lastChip},createChild:function(item){var chip=FilterKit.createElement("div.chip",{dataValue:item.value});chip.innerHTML=item.label+' <i class="close icon"></i>'+(this.options.addHiddenInput&&this.options.name?'<input type="hidden" name="'+this.options.name+'" value="'+item.value+'">':"");return chip},selectValue:function(item,fullItem){var lastChip,child;child=this.createChild(item);lastChip=this.getLastChip();this.container.insertBefore(child,lastChip?lastChip.nextSibling:this.container.firstChild)},unselectValue:function(value){var chip=this.container.querySelector('[data-value="'+value+'"]');if(chip){chip.parentElement.removeChild(chip)}},removeChip:function(chip){this.dispatch("removeValue",chip.getAttribute("data-value"))},preselectChip:function(chip){if(!chip)chip=this.getLastChip();if(chip){_(chip).addClass("preselect").siblings().removeClass("preselect")}},hasPreselected:function(){return this.container.querySelector(".preselect.chip")?true:false},removePreselected:function(){var chip=this.container.querySelector(".preselect."+this.itemClass);if(chip){this.removeChip(chip)}}});FilterKit.SelectOutput.Blocks=extend(FilterKit.SelectOutput.Chips,{itemClass:"block",createChild:function(item){var block=FilterKit.createElement("div.block",{dataValue:item.value});block.innerHTML=this.blockHtml?this.blockHtml(item):item.label;return block}});FilterKit.SelectOutput.Textfield=extend(Object,{init:function(el){this.textField=FilterKit.resolveElement(el)},selectValue:function(item){this.textField.value=item.label},unselectValue:function(value){this.textField.value=""}});FilterKit.SelectOutput.Text=extend(Object,{init:function(el){this.element=FilterKit.resolveElement(el)},selectValue:function(item){this.element.innerHTML=item.label},unselectValue:function(value){this.element.innerHTML=""}});FilterKit.Util.Searchbar=function(searchbarEl,collectionEl,options){var filters,searchbar,collection,collectionView;options=FilterKit.resolveOptions(options,{realTime:false,collectionType:"dom",baseUrl:"/"});filters=new FilterKit.Filters;searchbar=new FilterKit.Controls.Textfield(searchbarEl,filters,options);switch(options.collectionType){case"ajax_json":collection=new FilterKit.Collections.AjaxJSON(filters,options);break;case"ajax_html":collection=new FilterKit.Collections.AjaxHTML(filters,options);break;default:collection=new FilterKit.Collections.DOM(collectionEl,filters,options);break}collectionView=new FilterKit.CollectionViews.Div(collectionEl,collection);return filters};FilterKit.Util.SelectionDropdown=function(el,options){var dropdown,input,valueLabel,itemContainer,valueInput,listOutput,filters,searchInput,collection,collectionView,outputs,collapseTimeout,hlIndex,chips,list,isFocused,values,wrapper,wrapperPadding,display,contentPanel;dropdown=FilterKit.resolveElement(el);options=FilterKit.resolveOptions(options,{multiple:dropdown.classList.contains("multiple"),collectionType:"dom",inputName:"search",blockHtml:null,list:null});(function(){var inputs=_("input,select",dropdown);values=[];inputs.each(function(){var i;if(this.nodeName=="SELECT"){for(i=0;i<this.options.length;i++){if(this.options[i].selected&&this.options[i].value){values.push(this.options[i].value)}}}else if(this.value){if(this.name.substr(-2)=="[]"){values.push(this.value)}else{values=[this.value]}}});inputs.remove()})();(function(){var style;wrapper=FilterKit.createElement("div.fk-dropdownwrap");if(dropdown.classList.contains("fluid")){wrapper.classList.add("fluid")}if(dropdown.classList.contains("solid")){wrapper.classList.add("solid")}dropdown.parentElement.insertBefore(wrapper,dropdown);wrapper.appendChild(dropdown);if(options.list){listOutput=FilterKit.resolveElement(options.list)}else{listOutput=dropdown.querySelector(".list")}if(listOutput){listOutput.classList.add("fk-blocks");if(!options.list||_(options.list).closest(".fk-dropdown").length>0){wrapper.parentElement.insertBefore(listOutput,wrapper)}}style=getComputedStyle(dropdown);wrapperPadding=parseInt(style.paddingTop)+parseInt(style.paddingBottom)+(wrapper.offsetHeight-wrapper.clientHeight);display=FilterKit.createElement("div.fk-disp");dropdown.insertBefore(display,dropdown.firstChild)})();valueInput=dropdown.querySelector('input[type="hidden"]');if(!valueInput){valueInput=FilterKit.createElement('input[type="hidden"]');display.insertBefore(valueInput,display.firstElementChild)}input=dropdown.querySelector('input[type="text"]');if(!input){input=FilterKit.createElement('input[type="text"]');if(options.placeholder){input.setAttribute("placeholder",options.placeholder)}display.insertBefore(input,display.firstElementChild)}input.name=options.collectionType=="dom"?"label":options.inputName||input.name;valueLabel=dropdown.querySelector(".value");if(!valueLabel){valueLabel=FilterKit.createElement("div.value");input.parentElement.insertBefore(valueLabel,input.nextElementSibling)}if(options.multiple){valueLabel.classList.add("chips");valueLabel.appendChild(input)}else{display.insertBefore(FilterKit.createElement("i.fk-searchicon"),display.firstElementChild)}itemContainer=dropdown.querySelector(".items");(function(){var panel,ddIcon;contentPanel=FilterKit.createElement("div.contentpanel");dropdown.appendChild(contentPanel);panel=dropdown.querySelector(".panel");if(itemContainer){contentPanel.appendChild(itemContainer)}if(panel){contentPanel.appendChild(panel)}ddIcon=dropdown.querySelector(".dropdown.icon");if(!ddIcon){ddIcon=FilterKit.createElement("i.dropdown.icon")}display.appendChild(ddIcon)})();function expand(){cancelCollapse();updateDirection();isFocused=true;dropdown.classList.add("expanded");if(options.onShow){options.onShow()}}function delayToCollapse(){collapseTimeout=setTimeout(function(){collapseTimeout=null;isFocused=false;dropdown.classList.remove("expanded");if(options.onHide){options.onHide()}},200)}function cancelCollapse(){if(collapseTimeout){clearTimeout(collapseTimeout);collapseTimeout=null}}outputs=[];filters=new FilterKit.Filters;searchInput=new FilterKit.Controls.Textfield(input,filters,{keyboardNavigation:true,realTime:true,filledClass:"filled"});switch(options.collectionType){case"ajax_json":collection=new FilterKit.Collections.AjaxJSON(filters,options);
break;case"ajax_html":collection=new FilterKit.Collections.AjaxHTML(filters,options);break;default:collection=new FilterKit.Collections.DOM(collectionEl,filters,options);break}collectionView=new FilterKit.CollectionViews.Div(itemContainer,collection,{showSelected:options.multiple?"hidden":"highlighted",multiple:options.multiple});if(options.multiple){chips=new FilterKit.SelectOutput.Chips(valueLabel);outputs.push(chips);chips.on("removeValue",function(value){collection.unselectItem(value)});if(listOutput){list=new FilterKit.SelectOutput.Blocks(listOutput);outputs.push(list);if(options.blockHtml){list.blockHtml=options.blockHtml}}}else{outputs.push(new FilterKit.SelectOutput.Text(valueLabel))}hlIndex=-1;searchInput.onNavigationKey=function(key){var index,item;switch(key){case NAVKEY_UPARROW:index=collection.getPreviousFilteredItem(hlIndex,false,true,options.multiple);item=index<collection.items.length?collection.items[index]:null;if(item){collectionView.highlightItem(item,"highlight",true,true);hlIndex=index}break;case NAVKEY_DOWNARROW:index=collection.getNextFilteredItem(hlIndex,false,true,options.multiple);item=index<collection.items.length?collection.items[index]:null;if(item){collectionView.highlightItem(item,"highlight",true,true);hlIndex=index}break;case NAVKEY_RETURN:if(hlIndex>-1){item=collection.items[hlIndex];collection.selectItem(item,!options.multiple)}break;case NAVKEY_BACKSPACE_EMPTY:if(chips){if(chips.hasPreselected()){chips.removePreselected()}else{chips.preselectChip()}}break}};searchInput.onChange=function(value){collectionView.setTerm(value)};function clearInput(){input.value="";input.classList.remove("filled");collectionView.setTerm("");filters.addValue(input.name,"","like",true)}function updateWrapperHeight(){console.log(valueLabel.scrollHeight);wrapper.style.height=valueLabel.scrollHeight+wrapperPadding-6+"px"}function updateDirection(){var scrollTop=window.pageYOffset,vpHeight=window.innerHeight||document.documentElement.offsetHeight,offset=_(wrapper).offset();console.log(contentPanel.offsetHeight,scrollTop,vpHeight);if(offset.top+wrapper.offsetHeight+contentPanel.offsetHeight>scrollTop+vpHeight&&offset.top-contentPanel.offsetHeight>scrollTop){dropdown.classList.add("reverse")}else{dropdown.classList.remove("reverse")}}collection.on("selectItem",function(item){outputs.forEach(function(output){output.selectValue(item)});valueInput.value=item.value;clearInput();hlIndex=-1;if(!options.multiple&&options.onChange){options.onChange(item.value,item.label)}else if(options.multiple&&options.onLabelCreate){options.onLabelCreate(item.value,item.label)}updateWrapperHeight();if(options.multiple&&isFocused){input.focus()}else{input.blur()}});collection.on("beforeUnselectItem",function(item){if(options.multiple&&options.onLabelRemove){return options.onLabelRemove(item.value)}});collection.on("unselectItem",function(item){outputs.forEach(function(output){output.unselectValue(item.value)});updateWrapperHeight();if(options.multiple&&isFocused){input.focus()}});collectionView.on("addItem",function(term){var item;if(options.onAdd){item=options.onAdd(term);if(item){if(item instanceof Promise){item.then(function(item){collection.addItem(item);collection.selectItem(item)})}else{collection.addItem(item);collection.selectItem(item)}}}});input.addEventListener("focus",function(){expand()});input.addEventListener("blur",function(){delayToCollapse()});filters.on("exactMatch",function(item){console.log("Exact match",item);hlIndex=collectionView.highlightItem(item,"highlight",true,true);console.log(hlIndex)});(function(){var i;for(i=0;i<values.length;i++){collection.selectItem(values[i])}})()};if("$"in window){$.fn.searchbar=function(target,options){this.each(function(){this._filters=FilterKit.Util.Searchbar(this,target,options)});return this};$.fn.fkDropdown=function(options){this.each(function(){var $dd;options=FilterKit.resolveOptions(options,{allowAdditions:false,message:{addResult:"Add <strong>{term}</strong>",noResults:"No results found"}});if(this.nodeName=="SELECT"){$dd=$('<div class="fk-dropdown"></div>').prependTo(this).append(this)}else{$dd=$(this)}if($dd.find(".items").length==0){$dd.append('<div class="items"></div>')}if($dd.find(".items .noresults").length==0){$dd.find(".items").append('<div class="noresults item">'+options.message.noResults+"</div>")}if(options.allowAdditions&&$dd.find(".items .additem").length==0){$dd.find(".items").append('<div class="additem item">'+options.message.addResult+"</div>")}FilterKit.Util.SelectionDropdown($dd[0],options)});return this}}
//# sourceMappingURL=filterkit.min.js.map